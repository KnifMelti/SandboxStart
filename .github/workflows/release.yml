name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Create release ZIP
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        
        # Create temp directory
        $tempPath = Join-Path ([System.IO.Path]::GetTempPath()) "SandboxStart-$version"
        if (Test-Path $tempPath) {
          Remove-Item $tempPath -Recurse -Force
        }
        New-Item -ItemType Directory -Path $tempPath -Force | Out-Null
        
        # Files to include
        $filesToCopy = @(
          'SandboxStart.ps1',
          'Show-SandboxTestDialog.ps1',
          'Test-WindowsSandbox.ps1',
          'README.md'
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item $file -Destination $tempPath -Force
          }
        }
        
        # Copy shared submodule
        $sharedDest = Join-Path $tempPath "shared"
        New-Item -ItemType Directory -Path $sharedDest -Force | Out-Null
        Copy-Item "shared\SandboxTest.ps1" -Destination $sharedDest -Force
        if (Test-Path "shared\README.md") {
          Copy-Item "shared\README.md" -Destination $sharedDest -Force
        }
        
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" -Destination $tempPath -Force
        }
        
        Compress-Archive -Path "$tempPath\*" -DestinationPath "SandboxStart-$version.zip" -Force
        Remove-Item $tempPath -Recurse -Force
    
    - name: Get existing release body
      id: get_release
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: context.ref.replace('refs/tags/', '')
            });
            return release.data.body || '';
          } catch (error) {
            return '';
          }
    
    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        files: SandboxStart-*.zip
        body: |
          ## üì¶ Download
          
          **‚¨áÔ∏è Download:** `SandboxStart-${{ github.ref_name }}.zip` (includes all dependencies)
          
          ### üì• Quick Start
          1. Extract ZIP file
          2. Run `SandboxStart.ps1`
          3. Configure and launch sandbox
          
          ---
          
          ${{ steps.get_release.outputs.result }}
        draft: false
        prerelease: false

name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Create release ZIP
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        
        # Create temp directory
        $tempPath = Join-Path ([System.IO.Path]::GetTempPath()) "SandboxStart-$version"
        if (Test-Path $tempPath) {
          Remove-Item $tempPath -Recurse -Force
        }
        New-Item -ItemType Directory -Path $tempPath -Force | Out-Null
        
        # Files to include
        $filesToCopy = @(
          'SandboxStart.ps1',
          'Show-SandboxTestDialog.ps1',
          'Test-WindowsSandbox.ps1',
          'README.md'
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item $file -Destination $tempPath -Force
          }
        }
        
        # Copy shared submodule
        $sharedDest = Join-Path $tempPath "shared"
        New-Item -ItemType Directory -Path $sharedDest -Force | Out-Null
        Copy-Item "shared\SandboxTest.ps1" -Destination $sharedDest -Force
        if (Test-Path "shared\README.md") {
          Copy-Item "shared\README.md" -Destination $sharedDest -Force
        }
        
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" -Destination $tempPath -Force
        }
        
        Compress-Archive -Path "$tempPath\*" -DestinationPath "SandboxStart-$version.zip" -Force
        Remove-Item $tempPath -Recurse -Force
    
    - name: Get existing release notes
      id: existing_notes
      continue-on-error: true
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $tag = "${{ github.ref_name }}"
        try {
          $release = gh release view $tag --json body --jq .body
          if ($release) {
            # Save with proper encoding
            [System.IO.File]::WriteAllText("existing_notes.txt", $release, [System.Text.UTF8Encoding]::new($false))
            echo "HAS_NOTES=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "HAS_NOTES=false" >> $env:GITHUB_OUTPUT
          }
        } catch {
          echo "HAS_NOTES=false" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
    
    - name: Prepare release body
      id: release_body
      run: |
        # Use here-string with explicit line breaks
        $header = "## üì¶ Download`n`n"
        $header += "**‚¨áÔ∏è Download:** ``SandboxStart-${{ github.ref_name }}.zip`` (includes all dependencies)`n`n"
        $header += "### üì• Quick Start`n`n"
        $header += "1. Extract ZIP file`n"
        $header += "2. Run ``SandboxStart.ps1```n"
        $header += "3. Configure and launch sandbox`n`n"
        $header += "---`n`n"
        
        if ("${{ steps.existing_notes.outputs.HAS_NOTES }}" -eq "true" -and (Test-Path "existing_notes.txt")) {
          $existingNotes = [System.IO.File]::ReadAllText("existing_notes.txt", [System.Text.UTF8Encoding]::new($false))
          $fullBody = $header + $existingNotes
        } else {
          $fullBody = $header
        }
        
        # Save with UTF8 encoding (no BOM)
        [System.IO.File]::WriteAllText("release_body.txt", $fullBody, [System.Text.UTF8Encoding]::new($false))
      shell: pwsh
    
    - name: Create or Update Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        $tag = "${{ github.ref_name }}"
        $bodyFile = "release_body.txt"
        
        # Check if release exists
        $releaseExists = $false
        try {
          gh release view $tag | Out-Null
          $releaseExists = $true
        } catch {
          $releaseExists = $false
        }
        
        if ($releaseExists) {
          # Update existing release
          gh release upload $tag "SandboxStart-$tag.zip" --clobber
          gh release edit $tag --notes-file $bodyFile
        } else {
          # Create new release
          gh release create $tag "SandboxStart-$tag.zip" --title $tag --notes-file $bodyFile
        }
      shell: pwsh

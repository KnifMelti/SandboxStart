name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Create release ZIP
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        
        # Create temp directory
        $tempPath = Join-Path ([System.IO.Path]::GetTempPath()) "SandboxStart-$version"
        if (Test-Path $tempPath) {
          Remove-Item $tempPath -Recurse -Force
        }
        New-Item -ItemType Directory -Path $tempPath -Force | Out-Null
        
        # Files to include
        $filesToCopy = @(
          'SandboxStart.ps1',
          'Show-SandboxTestDialog.ps1',
          'Test-WindowsSandbox.ps1',
          'README.md'
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item $file -Destination $tempPath -Force
          }
        }
        
        # Copy shared submodule
        $sharedDest = Join-Path $tempPath "shared"
        New-Item -ItemType Directory -Path $sharedDest -Force | Out-Null
        Copy-Item "shared\SandboxTest.ps1" -Destination $sharedDest -Force
        if (Test-Path "shared\README.md") {
          Copy-Item "shared\README.md" -Destination $sharedDest -Force
        }
        
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" -Destination $tempPath -Force
        }
        
        Compress-Archive -Path "$tempPath\*" -DestinationPath "SandboxStart-$version.zip" -Force
        Remove-Item $tempPath -Recurse -Force
    
    - name: Create or Update Release
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const tag = context.ref.replace('refs/tags/', '');
          
          // Get existing release if it exists
          let existingBody = '';
          try {
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });
            existingBody = release.body || '';
          } catch (error) {
            console.log('No existing release found');
          }
          
          // Create header with proper line breaks
          const header = `**ðŸ“¦ Download:** \`SandboxStart-${tag}.zip\` (all dependencies included)

---

`;
          
          const fullBody = header + existingBody;
          
          // Try to update or create release
          try {
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });
            
            // Update existing
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: fullBody
            });
            
            // Upload asset
            const zipPath = `SandboxStart-${tag}.zip`;
            const zipContent = fs.readFileSync(zipPath);
            
            // Delete old asset
            for (const asset of release.assets) {
              if (asset.name === `SandboxStart-${tag}.zip`) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
            }
            
            // Upload new
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              name: `SandboxStart-${tag}.zip`,
              data: zipContent
            });
            
          } catch (error) {
            // Create new release
            const { data: newRelease } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              body: fullBody,
              draft: false,
              prerelease: false
            });
            
            // Upload asset
            const zipPath = `SandboxStart-${tag}.zip`;
            const zipContent = fs.readFileSync(zipPath);
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: newRelease.id,
              name: `SandboxStart-${tag}.zip`,
              data: zipContent
            });
          }
